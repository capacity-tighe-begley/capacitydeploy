<# Gary Blok - @gwblok - GARYTOWN.COM
Modified from: https://learn.microsoft.com/en-us/windows/deployment/update/media-dynamic-update
update Windows Preinstallation Environment (WinPE)


2023.05.12.01 - Original Release
2023.05.12.02 - Added ADK winpe.wim backup to winpe.bak before starting process
2023.05.12.03 - Added "Export-WindowsImage" 


#>
#Set First 3 Vars

#This is the default Path for ADK's x64 winpe.wim file:
$ADK_WINPE_PATH = "C:\Program Files (x86)\Windows Kits\10\Assessment and Deployment Kit\Windows Preinstallation Environment\amd64\en-us\winpe.wim"
$ExportPath = Split-Path -Path $ADK_WINPE_PATH

#Make this whatever you want
$WINPE_MOUNT = "c:\mount"

#This is where you downloaded the LCU to
$LCU_PATH = "C:\Users\gary.blok\Downloads\windows11.0-kb5026372-x64_d2e542ce70571b093d815adb9013ed467a3e0a85.msu"

# Get the list of images contained within WinPE
$WINPE_IMAGES = Get-WindowsImage -ImagePath $ADK_WINPE_PATH

if (!(test-path -path $WINPE_MOUNT)){New-Item -ItemType directory -Path $WINPE_MOUNT -ErrorAction stop | Out-Null}
function Get-TS { return "{0:HH:mm:ss}" -f [DateTime]::Now }

#backup orginail winpe.wim
if (!(Test-Path -path "$ExportPath\winpe.bak")){ Copy-Item -Path $ADK_WINPE_PATH -Destination "$ExportPath\winpe.bak"}

Foreach ($IMAGE in $WINPE_IMAGES) { #ADK only has one... but I'm just going to leave this here anyway
    # update WinPE
    Write-Output "$(Get-TS): Mounting WinPE, image index $($IMAGE.ImageIndex)"
    Mount-WindowsImage -ImagePath $ADK_WINPE_PATH -Index $IMAGE.ImageIndex -Path $WINPE_MOUNT -ErrorAction stop | Out-Null  
    
    # Add latest cumulative update first pass
    Write-Output "$(Get-TS): Adding package $LCU_PATH First Pass"
    try { Add-WindowsPackage -Path $WINPE_MOUNT -PackagePath $LCU_PATH | Out-Null }
    Catch
    {
        $theError = $_
        Write-Output "$(Get-TS): $theError"
        if ($theError.Exception -like "*0x8007007e*") {
            Write-Output "$(Get-TS): This failure is a known issue with combined cumulative update, we can ignore."
        }
        else {throw}
    }

    # Add latest cumulative update 2nd pass (this is typically after you've added language packs, etc)
    Write-Output "$(Get-TS): Adding package $LCU_PATH 2nd Pass"
    Add-WindowsPackage -Path $WINPE_MOUNT -PackagePath $LCU_PATH -ErrorAction stop | Out-Null  

    # Perform image cleanup
    Write-Output "$(Get-TS): Performing image cleanup on WinPE"
    DISM /image:$WINPE_MOUNT /cleanup-image /StartComponentCleanup | Out-Null
        
    # Dismount
    Dismount-WindowsImage -Path $WINPE_MOUNT -Save -ErrorAction stop | Out-Null
    Write-Output "$(Get-TS):Completed updating ADK WinPE"

    #Export WinPE
    
    Write-Output "$(Get-TS): Exporting image to $ExportPath\winpe_export.wim"
    Export-WindowsImage -SourceImagePath $ADK_WINPE_PATH -SourceIndex $IMAGE.ImageIndex -DestinationImagePath "$ExportPath\winpe_export.wim" -ErrorAction stop | Out-Null

}
 #Overwrite ADK winpe.wim
 Copy-Item -path "$ExportPath\winpe_export.wim" -Destination $ADK_WINPE_PATH -Force | Out-Null
 #Cleanup
 Remove-Item -Path "$ExportPath\winpe_export.wim"

